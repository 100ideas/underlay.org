# Migration `20201028182500-init`

This migration has been generated by Joel Gustafson at 10/28/2020, 2:25:01 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."collections" DROP CONSTRAINT "collections_organization_id_fkey"

ALTER TABLE "public"."collections" DROP CONSTRAINT "collections_user_id_fkey"

ALTER TABLE "public"."members" DROP CONSTRAINT "members_organizationId_fkey"

ALTER TABLE "public"."members" DROP CONSTRAINT "members_userId_fkey"

ALTER TABLE "public"."collections" DROP COLUMN "name",
DROP COLUMN "user_id",
DROP COLUMN "organization_id",
ADD COLUMN "agent_id" text   NOT NULL ,
ALTER COLUMN "slug" SET NOT NULL,
ALTER COLUMN "description" SET NOT NULL

ALTER TABLE "public"."members" DROP COLUMN "userId",
DROP COLUMN "organizationId",
ADD COLUMN "user_id" text   NOT NULL ,
ADD COLUMN "organization_id" text   NOT NULL 

CREATE TABLE "public"."agents" (
"id" text   NOT NULL ,
"userId" text   ,
"organizationId" text   ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."schemas" (
"id" text   NOT NULL ,
"slug" text   NOT NULL ,
"agent_id" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."schema_versions" (
"id" text   NOT NULL ,
"content" text   NOT NULL DEFAULT E'',
"readme" text   ,
"version_number" text   NOT NULL ,
"agent_id" text   NOT NULL ,
"schema_id" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."schema_collaborators" (
"id" text   NOT NULL ,
"user_id" text   NOT NULL ,
"schema_id" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."collection_versions" (
"id" text   NOT NULL ,
"hash" text   NOT NULL ,
"version_number" text   NOT NULL ,
"readme" text   ,
"collection_id" text   NOT NULL ,
"data_schema_id" text   NOT NULL ,
"meta_schema_id" text   NOT NULL ,
"meta_key" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"agent_id" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."collection_collaborators" (
"id" text   NOT NULL ,
"user_id" text   NOT NULL ,
"collection_id" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updated_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."assertions" (
"id" text   NOT NULL ,
"hash" text   NOT NULL ,
"collection_version_id" text   NOT NULL ,
"created_at" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE UNIQUE INDEX "agents_userId_unique" ON "public"."agents"("userId")

CREATE UNIQUE INDEX "agents_organizationId_unique" ON "public"."agents"("organizationId")

CREATE UNIQUE INDEX "schemas.agent_id_slug_unique" ON "public"."schemas"("agent_id", "slug")

CREATE UNIQUE INDEX "collections.agent_id_slug_unique" ON "public"."collections"("agent_id", "slug")

CREATE UNIQUE INDEX "organizations.slug_unique" ON "public"."organizations"("slug")

CREATE UNIQUE INDEX "users.slug_unique" ON "public"."users"("slug")

ALTER TABLE "public"."agents" ADD FOREIGN KEY ("userId")REFERENCES "public"."users"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."agents" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."organizations"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."schemas" ADD FOREIGN KEY ("agent_id")REFERENCES "public"."agents"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."schema_versions" ADD FOREIGN KEY ("agent_id")REFERENCES "public"."agents"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."schema_versions" ADD FOREIGN KEY ("schema_id")REFERENCES "public"."schemas"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."schema_collaborators" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."schema_collaborators" ADD FOREIGN KEY ("schema_id")REFERENCES "public"."schemas"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_versions" ADD FOREIGN KEY ("collection_id")REFERENCES "public"."collections"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_versions" ADD FOREIGN KEY ("data_schema_id")REFERENCES "public"."schema_versions"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_versions" ADD FOREIGN KEY ("meta_schema_id")REFERENCES "public"."schema_versions"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_versions" ADD FOREIGN KEY ("agent_id")REFERENCES "public"."agents"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_collaborators" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collection_collaborators" ADD FOREIGN KEY ("collection_id")REFERENCES "public"."collections"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."assertions" ADD FOREIGN KEY ("id")REFERENCES "public"."collection_versions"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."collections" ADD FOREIGN KEY ("agent_id")REFERENCES "public"."agents"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."members" ADD FOREIGN KEY ("user_id")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."members" ADD FOREIGN KEY ("organization_id")REFERENCES "public"."organizations"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200918091758-init-schema..20201028182500-init
--- datamodel.dml
+++ datamodel.dml
@@ -3,13 +3,13 @@
 }
 datasource db {
     provider = "postgresql"
-    url = "***"
+    url = "***"
 }
 model Account {
-    id                 String    @default(uuid()) @id
+    id                 String    @id @default(uuid())
     compoundId         String    @unique @map(name: "compound_id")
     userId             String    @map(name: "user_id")
     providerType       String    @map(name: "provider_type")
     providerId         String    @map(name: "provider_id")
@@ -17,90 +17,192 @@
     refreshToken       String?   @map(name: "refresh_token")
     accessToken        String?   @map(name: "access_token")
     accessTokenExpires DateTime? @map(name: "access_token_expires")
     createdAt          DateTime  @default(now()) @map(name: "created_at")
-    updatedAt          DateTime  @default(now()) @map(name: "updated_at") @updatedAt
+    updatedAt          DateTime  @default(now()) @updatedAt @map(name: "updated_at")
     @@index([providerAccountId], name: "providerAccountId")
     @@index([providerId], name: "providerId")
     @@index([userId], name: "userId")
     @@map(name: "accounts")
 }
 model Session {
-    id           String   @default(uuid()) @id
+    id           String   @id @default(uuid())
     userId       String   @map(name: "user_id")
     expires      DateTime
     sessionToken String   @unique @map(name: "session_token")
     accessToken  String   @unique @map(name: "access_token")
     createdAt    DateTime @default(now()) @map(name: "created_at")
-    updatedAt    DateTime @default(now()) @map(name: "updated_at") @updatedAt
+    updatedAt    DateTime @default(now()) @updatedAt @map(name: "updated_at")
     @@map(name: "sessions")
 }
 model VerificationRequest {
-    id         String   @default(uuid()) @id
+    id         String   @id @default(uuid())
     identifier String
     token      String   @unique
     expires    DateTime
     createdAt  DateTime @default(now()) @map(name: "created_at")
-    updatedAt  DateTime @default(now()) @map(name: "updated_at") @updatedAt
+    updatedAt  DateTime @default(now()) @updatedAt @map(name: "updated_at")
     @@map(name: "verification_requests")
 }
 model User {
-    id            String       @default(uuid()) @id
+    id            String    @id @default(uuid())
+    slug          String?   @unique
+    email         String?   @unique
     name          String?
-    email         String?      @unique
-    emailVerified DateTime?    @map(name: "email_verified")
     avatar        String?
-    slug          String?
-    collections   Collection[]
     organizations Member[]
-    createdAt     DateTime     @default(now()) @map(name: "created_at")
-    updatedAt     DateTime     @default(now()) @map(name: "updated_at") @updatedAt
+    emailVerified DateTime? @map(name: "email_verified")
+    createdAt     DateTime  @default(now()) @map(name: "created_at")
+    updatedAt     DateTime  @default(now()) @updatedAt @map(name: "updated_at")
+    collections CollectionCollaborator[]
+    schemas     SchemaCollaborator[]
+
+    Agent Agent
     @@map(name: "users")
 }
 model Organization {
-    id          String       @default(uuid()) @id
-    name        String?
-    avatar      String?
-    slug        String?
-    collections Collection[]
-    members     Member[]
-    createdAt   DateTime     @default(now()) @map(name: "created_at")
-    updatedAt   DateTime     @default(now()) @map(name: "updated_at") @updatedAt
+    id        String   @id @default(uuid())
+    slug      String?  @unique
+    name      String?
+    avatar    String?
+    members   Member[]
+    createdAt DateTime @default(now()) @map(name: "created_at")
+    updatedAt DateTime @default(now()) @updatedAt @map(name: "updated_at")
+    Agent Agent
     @@map(name: "organizations")
 }
-model Collection {
-    id             String        @default(uuid()) @id
-    name           String?
-    avatar         String?
-    slug           String?
-    description    String?
-    userId         String?       @map(name: "user_id")
-    user           User?         @relation(fields: [userId], references: [id])
-    organizationId String?       @map(name: "organization_id")
-    organization   Organization? @relation(fields: [organizationId], references: [id])
-    createdAt      DateTime      @default(now()) @map(name: "created_at")
-    updatedAt      DateTime      @default(now()) @map(name: "updated_at") @updatedAt
+model Agent {
+    id String @id @default(uuid())
-    @@map(name: "collections")
+    user               User?               @relation(fields: [userId], references: [id])
+    userId             String?
+    organization       Organization?       @relation(fields: [organizationId], references: [id])
+    organizationId     String?
+    schemas            Schema[]
+    collections        Collection[]
+    schemaVersions     SchemaVersion[]
+    collectionVersions CollectionVersion[]
+
+    @@map(name: "agents")
 }
 model Member {
-    id             String       @default(uuid()) @id
-    userId         String
+    id             String       @id @default(uuid())
+    userId         String       @map(name: "user_id")
     user           User         @relation(fields: [userId], references: [id])
-    organizationId String
+    organizationId String       @map(name: "organization_id")
     organization   Organization @relation(fields: [organizationId], references: [id])
     createdAt      DateTime     @default(now()) @map(name: "created_at")
-    updatedAt      DateTime     @default(now()) @map(name: "updated_at") @updatedAt
+    updatedAt      DateTime     @default(now()) @updatedAt @map(name: "updated_at")
     @@map(name: "members")
 }
+
+model Schema {
+    id            String               @id @default(uuid())
+    slug          String
+    agentId       String               @map(name: "agent_id")
+    agent         Agent                @relation(fields: [agentId], references: [id])
+    createdAt     DateTime             @default(now()) @map(name: "created_at")
+    updatedAt     DateTime             @default(now()) @updatedAt @map(name: "updated_at")
+    versions      SchemaVersion[]
+    collaborators SchemaCollaborator[]
+
+    @@unique([agentId, slug])
+    @@map(name: "schemas")
+}
+
+model SchemaVersion {
+    id              String              @id @default(uuid())
+    content         String              @default("") // Raw .toml text
+    readme          String?
+    versionNumber   String              @map(name: "version_number")
+    agentId         String              @map(name: "agent_id")
+    agent           Agent               @relation(fields: [agentId], references: [id])
+    schemaId        String              @map(name: "schema_id")
+    schema          Schema              @relation(fields: [schemaId], references: [id])
+    dataCollections CollectionVersion[] @relation("DataSchema")
+    metaCollections CollectionVersion[] @relation("MetaSchema")
+    createdAt       DateTime            @default(now()) @map(name: "created_at")
+
+    @@map(name: "schema_versions")
+}
+
+model SchemaCollaborator {
+    id        String   @id @default(uuid())
+    userId    String   @map(name: "user_id")
+    user      User     @relation(fields: [userId], references: [id])
+    schemaId  String   @map(name: "schema_id")
+    schema    Schema   @relation(fields: [schemaId], references: [id])
+    createdAt DateTime @default(now()) @map(name: "created_at")
+    updatedAt DateTime @default(now()) @updatedAt @map(name: "updated_at")
+
+    @@map(name: "schema_collaborators")
+}
+
+model Collection {
+    id            String                   @id @default(uuid())
+    slug          String
+    avatar        String?
+    description   String
+    agentId       String                   @map(name: "agent_id")
+    agent         Agent                    @relation(fields: [agentId], references: [id])
+    createdAt     DateTime                 @default(now()) @map(name: "created_at")
+    updatedAt     DateTime                 @default(now()) @updatedAt @map(name: "updated_at")
+    versions      CollectionVersion[]
+    collaborators CollectionCollaborator[]
+
+    @@unique([agentId, slug])
+    @@map(name: "collections")
+}
+
+model CollectionVersion {
+    id            String        @id @default(uuid())
+    hash          String
+    versionNumber String        @map(name: "version_number")
+    readme        String?
+    collectionId  String        @map(name: "collection_id")
+    collection    Collection    @relation(fields: [collectionId], references: [id])
+    dataSchemaId  String        @map(name: "data_schema_id")
+    dataSchema    SchemaVersion @relation(name: "DataSchema", fields: [dataSchemaId], references: [id])
+    metaSchemaId  String        @map(name: "meta_schema_id")
+    metaSchema    SchemaVersion @relation(name: "MetaSchema", fields: [metaSchemaId], references: [id])
+    metaKey       String        @map(name: "meta_key") // URI label from one of the classes in the metaSchema
+    createdAt     DateTime      @default(now()) @map(name: "created_at")
+    agentId       String        @map(name: "agent_id")
+    agent         Agent         @relation(fields: [agentId], references: [id])
+    assertions    Assertion[]
+
+    @@map(name: "collection_versions")
+}
+
+model CollectionCollaborator {
+    id           String     @id @default(uuid())
+    userId       String     @map(name: "user_id")
+    user         User       @relation(fields: [userId], references: [id])
+    collectionId String     @map(name: "collection_id")
+    collection   Collection @relation(fields: [collectionId], references: [id])
+    createdAt    DateTime   @default(now()) @map(name: "created_at")
+    updatedAt    DateTime   @default(now()) @updatedAt @map(name: "updated_at")
+
+    @@map(name: "collection_collaborators")
+}
+
+model Assertion {
+    id                  String            @id @default(uuid())
+    hash                String
+    collectionVersionId String            @map(name: "collection_version_id")
+    collectionVersion   CollectionVersion @relation(fields: [id], references: [id])
+    createdAt           DateTime          @default(now()) @map(name: "created_at")
+
+    @@map(name: "assertions")
+}
```


